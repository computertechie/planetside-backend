<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Working</title>
</head>
<body>
<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-2.2.3.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>
    var factions = {
        "Vanu Sovereignty": 1,
        "Terran Republic": 2,
        "New Conglomerate": 3
    };
    var data = [
        {faction: "Vanu Sovereignty", count: 2052},
        {faction: "Terran Republic", count: 2203},
        {faction: "New Conglomerate", count: 2176}
    ];
    var socket = io('/live');

    var width = 1000,
            height = 1000,
            radius = Math.min(width, height) / 2,
            textRad = Math.min(width, height) / 4;

    var color = d3.scale.ordinal().range(["#8B30C9", "#D21600", "#0B73DA"]);

    var pie = d3.layout.pie()
            .sort(null)
            .value(function (d) {
                return d.count;
            });

    var arc = d3.svg.arc()
            .outerRadius(radius * 0.8)
            .innerRadius(radius * 0.4);

    var outerArc = d3.svg.arc()
            .innerRadius(radius * 0.9)
            .outerRadius(radius * 0.9);

    var svg = d3.select("body").append("svg")
            .attr('width', width)
            .attr('height', height)
            .append('g')
            .attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')');

    svg.append('g').attr('class', 'slices');
    svg.append('g').attr('class', 'labels');

    var key = function (d) {
        return d.data.faction;
    };


    function update(newData) {
        //slices
        var slice = svg.select('.slices').selectAll('path.slice')
                .data(pie(newData), key);

        slice.enter()
                .insert('path')
                .style('fill', function (d) {
                    return color(factions[d.data.faction]);
                })
                .attr('class', 'slice');

        slice.transition().duration(1000)
                .attrTween('d', function (d) {
                    this._current = this._current || d;
                    var interpolate = d3.interpolate(this._current, d);
                    this._current = interpolate(0);
                    return function (t) {
                        return arc(interpolate(t));
                    }
                });

        slice.exit().remove();

        //labels
        var text = svg.select('.labels').selectAll('text')
                .data(pie(newData), key);

        text.enter()
                .append('text')
                .attr('dy', '.35em');

        function midAngle(d) {
            return d.startAngle + (d.endAngle - d.startAngle) / 2;
        }

        text.text(function (d) {
                    console.log(d);
                    return d.data.faction + " " + d.data.count;
                })
                .transition().duration(1000)
                .attrTween("transform", function (d) {
                    this._current = this._current || d;
                    var interpolate = d3.interpolate(this._current, d);
                    this._current = interpolate(0);
                    return function (t) {
                        var d2 = interpolate(t);
                        var pos = outerArc.centroid(d2);
                        pos[0] = textRad * (midAngle(d2) < Math.PI ? 1 : -1);
                        return "translate(" + pos + ")";
                    };
                })
                .styleTween("text-anchor", function (d) {
                    this._current = this._current || d;
                    var interpolate = d3.interpolate(this._current, d);
                    this._current = interpolate(0);
                    return function (t) {
                        var d2 = interpolate(t);
                        return midAngle(d2) < Math.PI ? "start" : "end";
                    };
                });

        text.exit()
                .remove();
    }

    socket.on('population', function (message) {
        var global = message.worlds.Connery.zones.Esamir;
        data.forEach(function (dataObj, index) {
            data[index].count = global[dataObj.faction];
        });

        update(data);
    });
</script>
</body>
</html>